{% extends 'layout.html' %}

{% block content %}
	<div class="calendar-page-header">
		<button id="prevMonth">&#8592; Prev</button>
		<span id="monthYear"></span>
		<button id="nextMonth">Next &#8594;</button>
	</div>
	<div class="calendar-weekdays">
		<div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
	</div>
	<div class="calendar-page-grid" id="calendarGrid"></div>

	<div class="modal" id="modal" style="display:none;">
		<div class="modal-content">
			<h2 id="modalDate"></h2>
			<ul id="modalItems"></ul>
			<input type="text" id="newItemInput" placeholder="Add item...">
			<button id="addItemBtn">Add</button>
			<button id="closeModalBtn" style="margin-left:1rem;">Close</button>
		</div>
	</div>

    <script>
		// Calendar state
		let currentDate = new Date();
		let currentMonth = currentDate.getMonth();
		let currentYear = currentDate.getFullYear();

		// Event storage
		function getEvents() {
			return JSON.parse(localStorage.getItem('calendarEvents') || '{}');
		}
		function saveEvents(events) {
			localStorage.setItem('calendarEvents', JSON.stringify(events));
		}

		// Render calendar
		function renderCalendar() {
			const grid = document.getElementById('calendarGrid');
			grid.innerHTML = '';
			const monthYear = document.getElementById('monthYear');
			const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
			monthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;

			const firstDay = new Date(currentYear, currentMonth, 1);
			const lastDay = new Date(currentYear, currentMonth + 1, 0);
			const today = new Date();

			// Fill empty cells before first day
			for (let i = 0; i < firstDay.getDay(); i++) {
				const emptyCell = document.createElement('div');
				emptyCell.className = 'calendar-page-day';
				grid.appendChild(emptyCell);
			}
			// Fill days
			for (let day = 1; day <= lastDay.getDate(); day++) {
				const cell = document.createElement('div');
				cell.className = 'calendar-page-day';
				if (
					day === today.getDate() &&
					currentMonth === today.getMonth() &&
					currentYear === today.getFullYear()
				) {
					cell.classList.add('today');
				}
				cell.innerHTML = `<div class="date">${day}</div><div class="items"></div>`;
				cell.addEventListener('click', () => openModal(day));
				// Show items for this day
				const events = getEvents();
				const key = `${currentYear}-${currentMonth+1}-${day}`;
				if (events[key] && events[key].length) {
					cell.querySelector('.items').innerHTML = events[key].map(e => `<div>â€¢ ${e}</div>`).join('');
				}
				grid.appendChild(cell);
			}
		}

		// Modal logic
		const modal = document.getElementById('modal');
		const modalDate = document.getElementById('modalDate');
		const modalItems = document.getElementById('modalItems');
		const newItemInput = document.getElementById('newItemInput');
		const addItemBtn = document.getElementById('addItemBtn');
		const closeModalBtn = document.getElementById('closeModalBtn');
		let modalDay = null;

		function openModal(day) {
			modalDay = day;
			modal.style.display = 'flex';
			modalDate.textContent = `${day} ${document.getElementById('monthYear').textContent}`;
			newItemInput.value = '';
			renderModalItems();
		}
		function closeModal() {
			modal.style.display = 'none';
		}
		function renderModalItems() {
			const key = `${currentYear}-${currentMonth+1}-${modalDay}`;
			const events = getEvents();
			modalItems.innerHTML = '';
			if (events[key] && events[key].length) {
				events[key].forEach((item, idx) => {
					const li = document.createElement('li');
					li.textContent = item;
					// Remove button
					const rmBtn = document.createElement('button');
					rmBtn.textContent = 'Remove';
					rmBtn.style.marginLeft = '1rem';
					rmBtn.onclick = () => {
						events[key].splice(idx,1);
						saveEvents(events);
						renderModalItems();
						renderCalendar();
					};
					li.appendChild(rmBtn);
					modalItems.appendChild(li);
				});
			} else {
				modalItems.innerHTML = '<li>No items for this day.</li>';
			}
		}
		addItemBtn.onclick = function() {
			const val = newItemInput.value.trim();
			if (!val) return;
			const key = `${currentYear}-${currentMonth+1}-${modalDay}`;
			const events = getEvents();
			if (!events[key]) events[key] = [];
			events[key].push(val);
			saveEvents(events);
			newItemInput.value = '';
			renderModalItems();
			renderCalendar();
		};
		closeModalBtn.onclick = closeModal;

		// Month navigation
		document.getElementById('prevMonth').onclick = function() {
			currentMonth--;
			if (currentMonth < 0) {
				currentMonth = 11;
				currentYear--;
			}
			renderCalendar();
		};
		document.getElementById('nextMonth').onclick = function() {
			currentMonth++;
			if (currentMonth > 11) {
				currentMonth = 0;
				currentYear++;
			}
			renderCalendar();
		};

		// Close modal on outside click
		modal.onclick = function(e) {
			if (e.target === modal) closeModal();
		};

		// Initial render
		renderCalendar();
	</script>
{% endblock %}